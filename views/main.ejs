<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Patient Billing Optimizer</title>
    <link rel="icon" href="/static/favicon.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            background: #f3f7fb;
        }
        .topbar { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
        .card {
            background: #fff; padding: 15px 20px; margin: 15px 0;
            border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }
        .toggle-buttons { display: flex; gap: 8px; align-items: center; }
        .toggle-buttons a {
            padding: 6px 14px; border-radius: 999px; border: 1px solid #1976d2;
            color: #1976d2; text-decoration: none; font-size: 0.9em;
        }
        .toggle-buttons a.active-view { background: #1976d2; color: #fff; }
        .topbar-actions { display: flex; align-items: center; gap: 12px; }
        .topbar-actions a.action-link { color: #1976d2; text-decoration: none; font-weight: bold; }
        label { display: block; margin-top: 8px; }
        input, select {
            width: 100%; padding: 6px; margin-top: 2px; border: 1px solid #ccc; border-radius: 4px;
        }
        button {
            margin-top: 10px; padding: 6px 12px; border: none; border-radius: 4px;
            background: #1976d2; color: #fff; cursor: pointer;
        }
        .delete-btn { background: #c62828; margin-right: 8px; }
        .delete-btn:hover { opacity: 0.9; }
        .card-actions { margin-top: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 8px; }
        th, td { border: 1px solid #ddd; padding: 6px; }
        th { background: #e8eef4; }
        .badge {
            padding: 2px 6px; border-radius: 4px; font-size: 0.75em; margin-left: 6px;
        }
        .active { background: #c8e6c9; }
        .discharged { background: #ffcdd2; }
        .muted { opacity: 0.6; font-style: italic; }
        img { max-height: 60px; vertical-align: middle; margin-right: 10px; }
        .card-header { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
        .card-title { margin:0; }
        .section-divider { border:0; border-top:1px solid #e5e8ec; margin:12px 0; }
        .section-header { display:flex; align-items:center; gap:8px; margin:0 0 6px 0; }
        .inline-muted { font-size:0.85em; color:#6b7280; }
        .card-header button { margin-top: 0; }
        .modal-backdrop {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.45);
            display: none; align-items: center; justify-content: center; z-index: 50;
        }
        .modal {
            background: #fff; padding: 16px 20px; border-radius: 8px; width: 90%; max-width: 420px;
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.18);
        }
        .modal-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
        .secondary-btn { background: #e2e8f0; color: #1f2937; }
        .timeline-actions { display:flex; gap:8px; align-items:center; justify-content:flex-end; }
        .save-indicator { font-size: 0.85em; font-weight: bold; color: #2e7d32; }
        .warning-banner { display:none; margin:8px 0; padding:8px 10px; border-radius:6px; background:#fff3cd; color:#7c5d00; border:1px solid #f0d58c; }
    </style>
</head>
<body>

<div class="topbar">
    <div>
        <img src="/static/ahs_logo.png" alt="AHS logo">
        <strong>Patient Billing Optimizer</strong>
    </div>
    <div class="toggle-buttons">
        <a href="/?view=active" class="<%= current_view === 'active' ? 'active-view' : '' %>">Active Patients</a>
        <a href="/optimization">Optimization Suite</a>
        <a href="/?view=archived" class="<%= current_view === 'archived' ? 'active-view' : '' %>">Archived Patients</a>
        <a href="/shift_grid">Shift Grid</a>
    </div>
    <div class="topbar-actions">
        <span>Logged in as <%= session.user %> &mdash; <a href="/logout">Logout</a></span>
    </div>
</div>

<% if (current_view === 'active') { %>
<div class="card">
    <h2>Create New Patient</h2>
    <form action="/patients" method="post">
        <label>Initials</label>
        <input type="text" name="patient_initials" maxlength="4" required>

        <label>Patient Identifier</label>
        <input type="text" name="patient_identifier" required>

        <label>Activation Date</label>
        <input type="date" name="start_date" value="<%= default_start_date %>" required>

        <label>Activation Time</label>
        <input type="time" name="start_time" value="<%= default_start_time %>" step="60">

        <button>Create Patient</button>
    </form>
</div>
<% } %>

<% if (current_view === 'active') { %>
<div class="card">
    <h3>Active Patients</h3>
<% if (active_patients.length) { %>
    <form method="get">
        <input type="hidden" name="view" value="active">
        <select name="selected_patient" onchange="this.form.submit()">
            <% active_patients.forEach((p) => { %>
            <option value="<%= p.id %>" <%= selected_patient && selected_patient.id === p.id ? 'selected' : '' %>>
                #<%= p.id %> - <%= p.initials %> - <%= p.identifier %>
            </option>
            <% }) %>
        </select>
    </form>
    <% } else { %>
    <p class="muted">None</p>
    <% } %>
</div>
<% } %>

<% if (current_view === 'archived') { %>
<div class="card">
    <h3>Archived Patients</h3>
    <% if (archived_patients.length) { %>
    <table>
        <tr><th>Initials</th><th>ID Number</th><th>Download</th><th>Re-activate</th><th>Delete</th></tr>
        <% archived_patients.forEach((p) => { %>
        <tr>
            <td><%= p.initials %></td>
            <td><%= p.identifier %></td>
            <td>
                <form action="/patients/<%= p.id %>/confirmed_pdf" method="get" style="margin:0;">
                    <button type="submit">Download</button>
                </form>
            </td>
            <td>
                <form action="/patients/<%= p.id %>/restore" method="post" style="margin:0;">
                    <button type="submit">Re-activate Patient</button>
                </form>
            </td>
            <td>
                <form action="/patients/<%= p.id %>/delete" method="post" style="margin:0;" onsubmit="return confirm('Permanently delete this patient? This cannot be undone.');">
                    <button type="submit" style="background:#c62828;">Delete Patient</button>
                </form>
            </td>
        </tr>
        <% }) %>
    </table>
    <% } else { %>
    <p class="muted">None</p>
    <% } %>
</div>
<% } %>

<% if (selected_patient && current_view !== 'archived') { %>
<div class="card">
    <div class="card-header">
        <div>
            <h2 class="card-title">
                Patient #<%= selected_patient.id %> - <%= selected_patient.initials %> - <%= selected_patient.identifier %>
                <% if (selected_patient.status === 'active') { %>
                    <span class="badge active">active</span>
                <% } else { %>
                    <span class="badge discharged">archived</span>
                <% } %>
                <span class="badge"><%= selected_patient.care_status %></span>
            </h2>
            <% if (selected_patient.start_display) { %>
            <p class="muted">Activated <%= selected_patient.start_display %></p>
            <% } %>
            <% if (selected_patient.discharge_display) { %>
            <p class="muted">Discharged <%= selected_patient.discharge_display %></p>
            <% } %>
        </div>
        <form action="/patients/<%= selected_patient.id %>/delete" method="post" onsubmit="return confirm('Delete this patient?');">
            <input type="hidden" name="view" value="<%= current_view %>">
            <button type="submit" class="delete-btn">Delete Patient</button>
        </form>
    </div>
    <hr class="section-divider">
    <div class="card-actions">
        <h3 class="section-header">Status Timeline</h3>
        <div class="save-indicator" id="timeline-save-indicator">Saved: --</div>
        <div class="warning-banner" id="timeline-warning"></div>
        <form id="status-timeline-form" action="/patients/<%= selected_patient.id %>/timeline" method="post">
            <table>
                <tr><th>Status</th><th>Date</th><th>Time</th><th>Extras</th></tr>
                <% status_timeline_rows.forEach((row) => { %>
                <tr>
                    <td><%= row.label %></td>
                    <td>
                        <% if (row.editable && row.raw_status !== 'Delivered') { %>
                            <% if (row.event_id) { %>
                                <input type="date" value="<%= row.date_value %>" data-event-id="<%= row.event_id %>">
                            <% } else { %>
                                <input type="date" name="<%= row.name_prefix %>_date" value="<%= row.date_value %>">
                            <% } %>
                        <% } else { %>
                            <span class="muted"><%= row.date_value || '-' %></span>
                        <% } %>
                    </td>
                    <td>
                        <% if (row.editable && row.raw_status !== 'Delivered') { %>
                            <% if (row.event_id) { %>
                                <input type="time" value="<%= row.time_value %>" step="60" data-event-id="<%= row.event_id %>">
                            <% } else { %>
                                <input type="time" name="<%= row.name_prefix %>_time" value="<%= row.time_value %>" step="60">
                            <% } %>
                        <% } else { %>
                            <span class="muted"><%= row.time_value || '-' %></span>
                        <% } %>
                    </td>
                    <td>
                        <% if (row.raw_status === 'Induction' && row.event_id) { %>
                            <label style="display:flex; align-items:center; gap:6px;">
                                <input type="checkbox" class="induction-nst-toggle" data-event-id="<%= row.event_id %>" value="1" <%= row.induction_nst ? 'checked' : '' %>>
                                NST
                            </label>
                        <% } else { %>
                            <span class="muted">-</span>
                        <% } %>
                    </td>
                </tr>
                <% }) %>
            </table>
        </form>
        <div class="timeline-actions">
            <button type="button" id="add-action-btn">+ Add Action</button>
        </div>
    </div>

<hr class="section-divider">
<h3 class="section-header">
    Patient Timeline
    <button type="button" id="timeline-refresh-btn" style="margin-left:auto;">&#10227;</button>
</h3>
<% if (timeline_entries.length) { %>
<table>
<tr><th>Date/Time</th><th>Doctor</th><th>Action / Status</th></tr>
<% timeline_entries.forEach((entry) => { %>
<tr>
    <td><%= format_display(entry.time) %></td>
    <td><% if (entry.doctor_name) { %>Dr. <%= entry.doctor_name %><% } else { %>-<% } %></td>
    <td>
        <% if (entry.status_row) { %>
            <strong><%= entry.action %></strong>
        <% } else { %>
            <%= entry.action %><% if (entry.delivery_by) { %> (<%= entry.delivery_by %>)<% } %>
        <% } %>
    </td>
</tr>
<% }) %>
</table>
<% } else { %>
<p class="muted">No timeline events for this patient yet.</p>
<% } %>

<% if (selected_patient.status === 'active') { %>

<% if (patient_doctors.length) { %>
<h3>Doctors Involved</h3>
<table>
<tr><th>ID</th><th>Doctor</th></tr>
<% patient_doctors.forEach((d) => { %>
<tr><td><%= d.id %></td><td>Dr. <%= d.name %></td></tr>
<% }) %>
</table>
<% } %>

<% if (patient_billings.length) { %>
<hr class="section-divider">
<h3 class="section-header">Billing Entries</h3>
<table>
<tr><th>Doctor</th><th>Code</th><th>Description</th><th>Amount</th><th>Date/Time</th></tr>
<% patient_billings.forEach((b) => { %>
<tr>
<td><% if (b.doctor) { %>Dr. <%= b.doctor.name %><% } else { %>Unknown<% } %></td>
<td><%= b.code %></td><td><%= b.description %></td><td><%= format_currency(b.amount) %></td>
<td><%= format_display(new Date(b.timestamp)) %></td>
</tr>
<% }) %>
</table>
<% } %>

<% } else { %>

<hr class="section-divider">
<h3>Final Optimized Billing</h3>
<% if (optimized_billings.length) { %>
<table>
<tr><th>Doctor</th><th>Code</th><th>Description</th><th>Amount</th><th>Date/Time</th></tr>
<% optimized_billings.forEach((b) => { %>
<tr>
<td><% if (b.doctor) { %>Dr. <%= b.doctor.name %><% } else { %>Unknown<% } %></td>
<td><%= b.code %></td><td><%= b.description %></td><td><%= format_currency(b.amount) %></td>
<td><%= format_display(new Date(b.timestamp)) %></td>
</tr>
<% }) %>
</table>
<h3>Total: $<%= format_currency(selected_patient.optimized_total) %></h3>
<% } else { %>
<p class="muted">No billing data.</p>
<% } %>

<hr class="section-divider">
<p class="muted">Archived patients cannot be modified.</p>

<form action="/patients/<%= selected_patient.id %>/restore" method="post">
    <button>Restore to Active</button>
</form>

<% } %>
</div>
<% } %>

<div id="add-action-modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="add-action-title">
        <h3 id="add-action-title" style="margin:0 0 8px 0;">Add Action</h3>
        <form id="add-action-form" action="/patients/<%= selected_patient ? selected_patient.id : '' %>/status_events" method="post">
            <label>Action</label>
            <select name="status_event" id="status-event-select">
                <option value="Triage">Triage</option>
                <option value="Admitted">Admitted</option>
                <option value="Delivered">Delivered</option>
                <option value="Discharged">Discharged</option>
                <option value="Induction">Induction</option>
                <option value="Continuous Monitoring">Continuous Monitoring</option>
            </select>
            <label>After which status?</label>
            <select name="status_after">
                <% add_action_targets.forEach((target) => { %>
                <option value="<%= target.value %>"><%= target.label %></option>
                <% }) %>
            </select>

            <label>Date</label>
            <input type="date" name="status_date" value="<%= status_default_date %>">

            <label>Time</label>
            <input type="time" name="status_time" value="<%= status_default_time %>" step="60">

            <label id="induction-nst-label" style="display:none;">
                <input type="checkbox" name="induction_nst" value="1">
                Bill Non-stress test (87.54A)
            </label>

            <div class="modal-actions">
                <button type="button" class="secondary-btn" data-close-modal="true">Cancel</button>
                <button type="submit">Save</button>
            </div>
        </form>
    </div>
</div>
<script>
    const modal = document.getElementById('add-action-modal');
    const openBtn = document.getElementById('add-action-btn');
    const closeButtons = document.querySelectorAll('[data-close-modal="true"]');

    if (openBtn && modal) {
        openBtn.addEventListener('click', () => {
            modal.style.display = 'flex';
            modal.setAttribute('aria-hidden', 'false');
        });
        closeButtons.forEach((btn) => {
            btn.addEventListener('click', () => {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
            });
        });
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
            }
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false') {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
            }
        });
    }
    const statusSelect = document.getElementById('status-event-select');
    const inductionNstLabel = document.getElementById('induction-nst-label');
    const toggleInductionNst = () => {
        if (!statusSelect || !inductionNstLabel) return;
        inductionNstLabel.style.display = statusSelect.value === 'Induction' ? 'block' : 'none';
        if (statusSelect.value !== 'Induction') {
            const checkbox = inductionNstLabel.querySelector('input[type="checkbox"]');
            if (checkbox) checkbox.checked = false;
        }
    };
    if (statusSelect) {
        statusSelect.addEventListener('change', toggleInductionNst);
        toggleInductionNst();
    }

    const nstToggles = document.querySelectorAll('.induction-nst-toggle');
    nstToggles.forEach((toggle) => {
        toggle.addEventListener('change', () => {
            const eventId = toggle.getAttribute('data-event-id');
            if (!eventId) return;
            const formData = new URLSearchParams();
            if (toggle.checked) {
                formData.append('induction_nst', '1');
            }
            fetch(`/patients/<%= selected_patient ? selected_patient.id : '' %>/status_events/${eventId}/induction_nst`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData.toString()
            });
        });
    });

    const timelineIndicator = document.getElementById('timeline-save-indicator');
    const timelineWarning = document.getElementById('timeline-warning');
    const updateTimelineIndicator = (label) => {
        if (!timelineIndicator) return;
        if (label) {
            timelineIndicator.textContent = label;
            return;
        }
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        const ss = String(now.getSeconds()).padStart(2, '0');
        timelineIndicator.textContent = `Saved: ${hh}:${mm}:${ss}`;
    };
    updateTimelineIndicator();

    const statusForm = document.getElementById('status-timeline-form');
    const selectedPatientId = '<%= selected_patient ? selected_patient.id : '' %>';
    const currentView = '<%= current_view %>';
    const formatToday = () => {
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    };
    const ensureDateForTimeInput = (input) => {
        if (!input || input.type !== 'time') return;
        const row = input.closest('tr');
        if (!row) return;
        const dateInput = row.querySelector('input[type="date"]');
        if (dateInput && !dateInput.value) {
            dateInput.value = formatToday();
        }
    };
    const parseRowDateTime = (row) => {
        if (!row) return null;
        const dateInput = row.querySelector('input[type="date"]');
        const timeInput = row.querySelector('input[type="time"]');
        const dateSpan = row.querySelector('td:nth-child(2) .muted');
        const timeSpan = row.querySelector('td:nth-child(3) .muted');
        const dateVal = dateInput ? dateInput.value : (dateSpan ? dateSpan.textContent.trim() : '');
        const timeVal = timeInput ? timeInput.value : (timeSpan ? timeSpan.textContent.trim() : '');
        if (!dateVal || dateVal === '-') return null;
        const timePart = timeVal && timeVal !== '-' ? timeVal : '00:00';
        const parsed = new Date(`${dateVal}T${timePart}`);
        return Number.isNaN(parsed.valueOf()) ? null : parsed;
    };
    const validateTimelineOrder = () => {
        if (!statusForm) return true;
        const rows = Array.from(statusForm.querySelectorAll('table tr')).slice(1);
        let lastTime = null;
        let lastLabel = '';
        for (const row of rows) {
            const labelCell = row.querySelector('td');
            const label = labelCell ? labelCell.textContent.trim() : '';
            const rowTime = parseRowDateTime(row);
            if (!rowTime) continue;
            if (lastTime && rowTime < lastTime) {
                if (timelineWarning) {
                    timelineWarning.textContent = `Timeline must be chronological. ${label} cannot be before ${lastLabel}.`;
                    timelineWarning.style.display = 'block';
                }
                return false;
            }
            lastTime = rowTime;
            lastLabel = label;
        }
        if (timelineWarning) {
            timelineWarning.textContent = '';
            timelineWarning.style.display = 'none';
        }
        return true;
    };
    const saveTimelineForm = () => {
        if (!statusForm) return;
        if (!validateTimelineOrder()) return;
        updateTimelineIndicator('Saving...');
        const formData = new URLSearchParams(new FormData(statusForm));
        fetch(statusForm.action, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData.toString()
        })
            .finally(() => updateTimelineIndicator());
    };

    const baseInputs = statusForm ? statusForm.querySelectorAll('input[name$="_date"], input[name$="_time"]') : [];
    baseInputs.forEach((input) => {
        if (!input.hasAttribute('data-event-id')) {
            input.addEventListener('change', () => {
                ensureDateForTimeInput(input);
                saveTimelineForm();
            });
        }
    });

    const eventInputs = statusForm ? statusForm.querySelectorAll('input[data-event-id]') : [];
    eventInputs.forEach((input) => {
        input.addEventListener('change', () => {
            ensureDateForTimeInput(input);
            if (!validateTimelineOrder()) return;
            const eventId = input.getAttribute('data-event-id');
            if (!eventId) return;
            const row = input.closest('tr');
            if (!row) return;
            const dateInput = row.querySelector('input[type="date"][data-event-id]');
            const timeInput = row.querySelector('input[type="time"][data-event-id]');
            if (!dateInput || !dateInput.value) return;
            updateTimelineIndicator('Saving...');
            const formData = new URLSearchParams();
            formData.append('status_date', dateInput.value);
            if (timeInput && timeInput.value) {
                formData.append('status_time', timeInput.value);
            }
            fetch(`/patients/<%= selected_patient ? selected_patient.id : '' %>/status_events/${eventId}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData.toString()
            }).finally(() => updateTimelineIndicator());
        });
    });

    const refreshBtn = document.getElementById('timeline-refresh-btn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
            if (!selectedPatientId) return;
            window.location = `/?view=${currentView}&selected_patient=${selectedPatientId}`;
        });
    }
</script>
</body>
</html>
