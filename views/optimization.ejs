<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Billing Optimization Suite</title>
    <link rel="icon" href="/static/favicon.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            background: #f3f7fb;
        }
        .card {
            background: #fff; padding: 15px 20px; margin: 15px 0;
            border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }
        .topbar { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
        .topbar .toggle-buttons { flex: 1; justify-content: center; }
        .toggle-buttons { display: flex; gap: 8px; align-items: center; }
        .toggle-buttons a {
            padding: 6px 14px; border-radius: 999px; border: 1px solid #1976d2;
            color: #1976d2; text-decoration: none; font-size: 0.9em;
        }
        .toggle-buttons a.active-view { background: #1976d2; color: #fff; }
        label { display: block; margin-top: 8px; }
        select, button {
            padding: 6px 12px; border-radius: 4px; border: 1px solid #ccc;
        }
        button { background: #1976d2; color: #fff; border: none; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 8px; }
        th, td { border: 1px solid #ddd; padding: 6px; }
        th { background: #e8eef4; }
        .muted { opacity: 0.6; font-style: italic; }
        img { max-height: 60px; vertical-align: middle; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="topbar">
        <div>
            <img src="/static/ahs_logo.png" alt="AHS logo">
            <strong>Patient Billing Optimizer</strong>
        </div>
        <div class="toggle-buttons">
            <a href="/?view=active">Active Patients</a>
            <a href="/optimization" class="active-view">Optimization Suite</a>
            <a href="/?view=archived">Archived Patients</a>
            <a href="/shift_grid">Shift Grid</a>
        </div>
        <div class="topbar-actions">
            <span>Logged in as <%= session.user %> &mdash; <a href="/logout">Logout</a></span>
        </div>
    </div>

    <div class="card">
        <h2>Optimization View</h2>
        <form method="get" action="/optimization" style="margin-top:8px;">
            <label>View Mode</label>
            <select name="view_mode" onchange="this.form.submit()">
                <option value="patient" <%= view_mode === 'patient' ? 'selected' : '' %>>Patient</option>
                <option value="doctor" <%= view_mode === 'doctor' ? 'selected' : '' %>>Doctor</option>
            </select>
            <% if (view_mode === 'patient' && selected_patient) { %>
            <input type="hidden" name="selected_patient" value="<%= selected_patient.id %>">
            <% } %>
            <% if (view_mode === 'doctor' && selected_doctor) { %>
            <input type="hidden" name="selected_doctor" value="<%= selected_doctor.id %>">
            <% } %>
        </form>

        <% if (view_mode === 'patient') { %>
        <h3 style="margin-top:12px;">Active Patient Optimization</h3>
        <% if (active_patients.length) { %>
        <form method="get" action="/optimization">
            <input type="hidden" name="view_mode" value="patient">
            <label>Select Patient</label>
            <select name="selected_patient" onchange="this.form.submit()">
                <% active_patients.forEach((p) => { %>
                <option value="<%= p.id %>" <%= selected_patient && selected_patient.id === p.id ? 'selected' : '' %>>
                    #<%= p.id %> - <%= p.initials %> - <%= p.identifier %>
                </option>
                <% }) %>
            </select>
        </form>
        <% if (selected_patient) { %>
        <button type="submit" form="confirm-form" style="margin-top:10px;" id="confirm-archive-btn">Confirm and Archive</button>
        <% } %>
        <% } else { %>
        <p class="muted">No active patients available.</p>
        <% } %>
        <% } %>

        <% if (view_mode === 'doctor') { %>
        <h3 style="margin-top:12px;">Recent Doctors (Last 4 Days)</h3>
        <% if (recent_doctors && recent_doctors.length) { %>
        <form method="get" action="/optimization">
            <input type="hidden" name="view_mode" value="doctor">
            <label>Select Doctor</label>
            <select name="selected_doctor" onchange="this.form.submit()">
                <% recent_doctors.forEach((doc) => { %>
                <option value="<%= doc.id %>" <%= selected_doctor && selected_doctor.id === doc.id ? 'selected' : '' %>>
                    Dr. <%= doc.name %>
                </option>
                <% }) %>
            </select>
        </form>
        <% } else { %>
        <p class="muted">No recent doctors found in the last 4 days.</p>
        <% } %>
        <% } %>
    </div>

    <% if (view_mode === 'patient' && selected_patient) { %>
    <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
            <div>
                <h3 style="margin:0;">Suggested Optimized Billing</h3>
                <p class="muted" style="margin:6px 0 0;">Patient #<%= selected_patient.id %> &mdash; <%= selected_patient.initials %> / <%= selected_patient.identifier %></p>
            </div>
        </div>

        <table>
            <tr><th>Status Event</th><th>Date/Time</th></tr>
            <tr>
                <td>Triage</td>
                <td><%= selected_patient.start_datetime ? format_display(new Date(selected_patient.start_datetime)) : '-' %></td>
            </tr>
            <tr>
                <td>Admitted</td>
                <td><%= selected_patient.care_admitted_at ? format_display(new Date(selected_patient.care_admitted_at)) : '-' %></td>
            </tr>
            <tr>
                <td>Delivered</td>
                <td><%= selected_patient.care_delivered_at ? format_display(new Date(selected_patient.care_delivered_at)) : '-' %></td>
            </tr>
            <tr>
                <td>Discharged</td>
                <td><%= selected_patient.discharge_datetime ? format_display(new Date(selected_patient.discharge_datetime)) : '-' %></td>
            </tr>
        </table>

        <% if (optimization_error) { %>
        <p class="muted"><%= optimization_error %></p>
        <% } %>

        <% if (!optimization_error && optimization_notes && optimization_notes.length) { %>
        <div class="card" style="margin-top:12px;">
            <strong>Optimization Notes</strong>
            <ul style="margin:6px 0 0; padding-left:18px;">
                <% optimization_notes.forEach((note) => { %>
                <li><%= note %></li>
                <% }) %>
            </ul>
        </div>
        <% } %>

        <% if (!optimization_error && recommendations.length) { %>
        <table>
            <tr><th>Time</th><th>Code</th><th>Modifier</th><th>Doctor</th></tr>
            <% recommendations.forEach((rec) => { %>
            <tr>
                <td><%= format_display(rec.time) %></td>
                <td><%= rec.code %></td>
                <td><%= rec.modifier || '-' %></td>
                <td><%= rec.doctor ? ('Dr. ' + rec.doctor.name) : '-' %></td>
            </tr>
            <% }) %>
        </table>
        <% } %>

    <% if (selected_patient && baby_patient) { %>
    <div class="card">
        <h3 style="margin:0;">Baby Billing Codes</h3>
        <p class="muted" style="margin:6px 0 0;">
            Patient #<%= baby_patient.id %> &mdash; <%= baby_patient.initials %> / <%= baby_patient.identifier %>
            <% if (baby_patient.baby_gender) { %>
                &mdash; <%= baby_patient.baby_gender %>
            <% } %>
            <% if (baby_patient.baby_resuscitation) { %>
                &mdash; Resuscitation
            <% } %>
        </p>
            <% if (baby_recommendations && baby_recommendations.length) { %>
            <table>
                <tr><th>Time</th><th>Code</th><th>Modifier</th><th>Doctor</th></tr>
                <% baby_recommendations.forEach((rec) => { %>
                <tr>
                    <td><%= format_display(rec.time) %></td>
                    <td><%= rec.code %></td>
                    <td><%= rec.modifier || '-' %></td>
                    <td><%= rec.doctor ? ('Dr. ' + rec.doctor.name) : '-' %></td>
                </tr>
                <% }) %>
            </table>
        <% } else { %>
        <p class="muted">No baby billing codes generated yet.</p>
        <% } %>
    </div>
    <% } %>


    </div>
    <% } %>

    <% if (view_mode === 'doctor') { %>
    <div class="card">
        <strong>Billing Entry Summary</strong>
        <% if (doctor_billings_locked) { %>
        <p class="muted" style="margin-top:8px;">Doctor is not currently active on shift. Billing edits are locked until re-activated.</p>
        <% } %>
        <% if (summary_tables && summary_tables.length) { %>
        <% summary_tables.forEach((table) => { %>
        <table style="margin-top:12px;">
            <tr>
                <th colspan="15" style="text-align:left;">
                    Dr. <%= table.doctor ? table.doctor.name : 'Unknown' %>
                    &mdash; <%= table.shift_date || '-' %>
                    &mdash; <%= table.shift_day || '-' %>
                    &mdash; <%= table.shift_type || '-' %> Shift
                </th>
            </tr>
            <tr>
                <th>Pt Identifier</th>
                <th>Date of Service</th>
                <th>Diagnostic Code</th>
                <th>Billing Code</th>
                <th># Calls</th>
                <th>Encounter #</th>
                <th>Modifier</th>
                <th>CMGP #</th>
                <th>BMI</th>
                <th colspan="6">03.01AA</th>
            </tr>
            <tr>
                <th colspan="9"></th>
                <th>TEV</th>
                <th>TWK</th>
                <th>TNTP</th>
                <th>TNTA</th>
                <th>TST</th>
                <th>TDES</th>
            </tr>
            <% if (table.rows && table.rows.length) { %>
            <% table.rows.forEach((row) => { %>
            <tr>
                <td><%= row.patient_identifier %></td>
                <td><%= row.date_of_service %></td>
                <td>
                    <% if (row.doctor_id && !doctor_billings_locked) { %>
                    <form method="post" action="/optimization/diagnostic_code" style="display:flex; gap:6px; align-items:center;">
                        <input type="hidden" name="doctor_id" value="<%= row.doctor_id %>">
                        <input type="hidden" name="patient_id" value="<%= row.patient_id %>">
                        <input type="hidden" name="patient_key" value="<%= row.patient_key %>">
                        <input type="hidden" name="date_of_service" value="<%= row.date_of_service %>">
                        <input type="hidden" name="billing_code" value="<%= row.billing_code %>">
                        <input type="hidden" name="encounter_number" value="<%= row.encounter_number %>">
                        <input type="text" name="diagnostic_code" inputmode="numeric" pattern="[0-9]{3}" maxlength="3" placeholder="001-999" value="<%= row.diagnostic_code || '' %>" style="width:78px;">
                        <button type="submit" style="padding:4px 8px; font-size:0.8em;">Save</button>
                    </form>
                    <% } else { %>
                    <%= row.diagnostic_code || '' %>
                    <% } %>
                </td>
                <td><%= row.billing_code %></td>
                <td>
                    <% if (row.billing_code === '87.89B' && row.doctor_id && !doctor_billings_locked) { %>
                    <form method="post" action="/optimization/number_of_calls" style="display:flex; gap:6px; align-items:center;">
                        <input type="hidden" name="doctor_id" value="<%= row.doctor_id %>">
                        <input type="hidden" name="patient_id" value="<%= row.patient_id %>">
                        <input type="hidden" name="patient_key" value="<%= row.patient_key %>">
                        <input type="hidden" name="date_of_service" value="<%= row.date_of_service %>">
                        <input type="hidden" name="billing_code" value="<%= row.billing_code %>">
                        <input type="hidden" name="encounter_number" value="<%= row.encounter_number %>">
                        <input type="number" name="number_of_calls" min="1" max="99" step="1" value="<%= row.number_of_calls %>" style="width:70px;">
                        <button type="submit" style="padding:4px 8px; font-size:0.8em;">Save</button>
                    </form>
                    <% } else { %>
                    <%= row.number_of_calls %>
                    <% } %>
                </td>
                <td><%= row.encounter_number %></td>
                <td><%= row.modifier || '' %></td>
                <td><%= row.cmgp_modifier || '' %></td>
                <td><%= row.bmi_modifier || '' %></td>
                <td><%= row.aa_counts && row.aa_counts.TEV ? row.aa_counts.TEV : '' %></td>
                <td><%= row.aa_counts && row.aa_counts.TWK ? row.aa_counts.TWK : '' %></td>
                <td><%= row.aa_counts && row.aa_counts.TNTP ? row.aa_counts.TNTP : '' %></td>
                <td><%= row.aa_counts && row.aa_counts.TNTA ? row.aa_counts.TNTA : '' %></td>
                <td><%= row.aa_counts && row.aa_counts.TST ? row.aa_counts.TST : '' %></td>
                <td><%= row.aa_counts && row.aa_counts.TDES ? row.aa_counts.TDES : '' %></td>
            </tr>
            <% }) %>
            <% } else { %>
            <tr>
                <td colspan="15" class="muted">No summary entries for this doctor yet.</td>
            </tr>
            <% } %>
        </table>
        <% }) %>
        <% } else { %>
        <p class="muted">No summary entries for this doctor yet.</p>
        <% } %>
    </div>
    <% } %>

    <% if (view_mode === 'patient' && selected_patient) { %>
    <div class="card">
        <h3>Billing Notes</h3>
        <form id="confirm-form" method="post" action="/optimization/<%= selected_patient.id %>/confirm">
            <input type="hidden" id="discharge-present" value="<%= selected_patient.discharge_datetime ? '1' : '0' %>">
            <label>Patient-specific notes</label>
            <textarea name="billing_note" rows="4" style="width:100%; padding:8px; border-radius:4px; border:1px solid #ccc;"><%= selected_patient.billing_note || '' %></textarea>
        </form>
    </div>
    <% } %>
</body>
<script>
    const confirmBtn = document.getElementById('confirm-archive-btn');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', (event) => {
            const proceed = window.confirm('Archive this patient now? This action is irreversible.');
            if (!proceed) {
                event.preventDefault();
            }
        });
    }
</script>
</html>
