<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Shift Grid</title>
    <link rel="icon" href="/static/favicon.png">
    <style>
        body { font-family: Arial, sans-serif; max-width: 1100px; margin:0 auto; padding:20px; background:#f3f7fb; }
        .card { background:#fff; padding:15px 20px; margin:15px 0; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.08); }
        table { width:100%; border-collapse:collapse; }
        th, td { border:1px solid #ddd; padding:6px; text-align:center; }
        th { background:#e8eef4; }
        select { width:100%; }
        .topbar { display:flex; justify-content:space-between; align-items:center; }
        .muted { opacity:0.7; font-style:italic; }
        .divider { margin:12px 0; border-bottom:1px solid #ddd; }
        button { padding:8px 12px; border:none; border-radius:4px; background:#1976d2; color:#fff; cursor:pointer; }
        input[type="date"] { padding:6px; }
        .locked-cell { background: #f0f3f7; opacity: 0.7; }
        .triage-extras, .delivery-extras { margin-top: 4px; text-align: left; font-size: 0.85em; }
        .triage-extras label, .delivery-extras label { display: flex; align-items: center; gap: 6px; margin: 2px 0; }
        .save-indicator { font-size: 0.85em; font-weight: bold; color: #2e7d32; }
        .warning-banner { display:none; margin:10px 0; padding:8px 10px; border-radius:6px; background:#fff3cd; color:#7c5d00; border:1px solid #f0d58c; }
        .cell-warning { outline: 2px solid #f0ad4e; }
        .disabled-link { opacity: 0.5; pointer-events: none; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="topbar">
        <div>
            <strong>Shift Grid</strong> &mdash; Dr. <%= shiftDoctor.name %>
        </div>
        <div>
            <a href="/?view=active" data-save-grid="true">Back to Patients</a>
            <span style="margin:0 8px;">|</span>
            <a href="/doctors/manage" data-save-grid="true">Manage Doctors</a>
        </div>
    </div>
    <div class="save-indicator" id="save-indicator">Saved: --</div>
    <div class="warning-banner" id="grid-warning"></div>
    <% if (is_read_only) { %>
    <div class="card">
        <p class="muted">Viewing a previous shift grid. This view is read-only.</p>
    </div>
    <% } %>

    <div class="card">
        <p class="muted">Fill 15-minute slots. Leave blank if no patient was attended.</p>
        <div class="muted">Shift window: <%= format_display_24(new Date(shiftWindow.start_datetime)) %> to <%= format_display_24(new Date(shiftWindow.end_datetime)) %></div>
        <form id="grid-form" method="post" action="/shift_grid">
            <% segments.forEach((segment) => { %>
            <h4 style="margin-bottom:6px;"><%= segment.date.toLocaleString('en-US', { month: 'short', day: '2-digit', year: 'numeric' }) %></h4>
            <table>
                <tr><th>Hour</th><th>00</th><th>15</th><th>30</th><th>45</th></tr>
                <% for (let row = 0; row < Math.ceil(segment.slots.length / 4); row += 1) { %>
                <tr>
                    <% const base = row * 4; %>
                    <% const hourSlot = segment.slots[base] || null; %>
                    <th><% if (hourSlot) { %><%= hourSlot.toLocaleString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }).split(':')[0] %>:00<% } %></th>
                    <% for (let offset = 0; offset < 4; offset += 1) { %>
                        <% const idx = base + offset; %>
                        <% const slotTime = segment.slots[idx] || null; %>
                        <% if (slotTime) { %>
                        <% const slotKey = format_local(slotTime); %>
                        <% const slotObj = existing[slotKey]; %>
                        <% const existingPatient = slotObj ? slotObj.patient_id : null; %>
                        <% const existingAction = slotObj ? slotObj.action : ''; %>
                        <% const existingDelivery = slotObj ? slotObj.delivery_by : ''; %>
                        <% const existingDeliveryCode = slotObj ? slotObj.delivery_code : ''; %>
                        <% const existingDeliveryTime = slotObj ? slotObj.delivery_time : ''; %>
                        <% const existingPph = slotObj ? slotObj.delivery_postpartum_hemorrhage : 0; %>
                        <% const existingVacuum = slotObj ? slotObj.delivery_vacuum : 0; %>
                        <% const existingLaceration = slotObj ? slotObj.delivery_vaginal_laceration : 0; %>
                        <% const existingDystocia = slotObj ? slotObj.delivery_shoulder_dystocia : 0; %>
                        <% const existingPlacenta = slotObj ? slotObj.delivery_manual_placenta : 0; %>
                        <% const existingNst = slotObj ? slotObj.triage_non_stress_test : 0; %>
                        <% const existingSpeculum = slotObj ? slotObj.triage_speculum_exam : 0; %>
                        <% const isLocked = slotObj && slotObj.locked === 1; %>
                        <% const hasCommittedAction = existingPatient && existingAction; %>
                        <td data-locked="<%= isLocked ? '1' : '0' %>" data-slot-time="<%= slotKey %>" class="<%= (is_read_only || isLocked) ? 'locked-cell' : '' %>">
                            <div class="slot-time" style="font-size:0.8em; margin-bottom:4px;"><%= slotTime.toLocaleString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }) %></div>
                            <select class="patient-select" name="slot_patient_<%= Math.floor(slotTime.getTime() / 1000) %>" onchange="saveGrid(); applyCellState(this.closest('td'));" <%= (isLocked || is_read_only) ? 'disabled' : '' %>>
                                <option value="" <%= !existingPatient ? 'selected' : '' %>>--</option>
                                <% active_patients.forEach((p) => { %>
                                <% if (p.status !== 'active' && existingPatient !== p.id) { return; } %>
                                <option value="<%= p.id %>"
                                        data-status="<%= p.care_status %>"
                                        data-triage-action="<%= p.triage_action || 'triage_visit' %>"
                                        data-triage-start="<%= p.start_datetime || '' %>"
                                        data-status-events='<%- JSON.stringify(p.status_events || []) %>'
                                        data-admitted-at="<%= p.care_admitted_at || '' %>"
                                        data-delivered-at="<%= p.care_delivered_at || '' %>"
                                        data-discharged-at="<%= p.discharge_datetime || '' %>"
                                        <%= p.status !== 'active' ? 'disabled' : '' %>
                                        <%= existingPatient === p.id ? 'selected' : '' %>>
                                    <%= p.initials %> (<%= p.identifier %>)<%= p.status !== 'active' ? ' - archived' : '' %>
                                </option>
                                <% }) %>
                            </select>
                            <select class="action-select" data-existing-action="<%= existingAction || '' %>" name="slot_action_<%= Math.floor(slotTime.getTime() / 1000) %>" onchange="applyCellState(this.closest('td')); saveGrid();" <%= (isLocked || is_read_only) ? 'disabled' : '' %>>
                                <option value="" <%= !existingAction ? 'selected' : '' %>>--</option>
                            </select>
                            <select class="delivery-select" name="slot_delivery_code_<%= Math.floor(slotTime.getTime() / 1000) %>" onchange="saveGrid()" <%= existingAction !== 'delivery' ? 'disabled style="display:none;"' : 'style="display:block;"' %> <%= (isLocked || is_read_only) ? 'disabled' : '' %>>
                                <% const fallbackDeliveryCode = existingDeliveryCode || (existingDelivery === 'ob' ? '87.98B' : '87.98A'); %>
                                <option value="87.98A" <%= fallbackDeliveryCode === '87.98A' ? 'selected' : '' %>>87.98A (FP/MW)</option>
                                <option value="87.98B" <%= fallbackDeliveryCode === '87.98B' ? 'selected' : '' %>>87.98B (OB)</option>
                                <option value="87.98C" <%= fallbackDeliveryCode === '87.98C' ? 'selected' : '' %>>87.98C (FP/MW VBAC)</option>
                            </select>
                            <input class="delivery-time" type="datetime-local" name="slot_delivery_time_<%= Math.floor(slotTime.getTime() / 1000) %>"
                                   value="<%= existingDeliveryTime || slotKey %>"
                                   onchange="saveGrid()"
                                   <%= existingAction !== 'delivery' ? 'style="display:none;" disabled' : 'style="display:block;"' %> <%= (isLocked || is_read_only) ? 'disabled' : '' %>>
                            <div class="delivery-extras" data-delivery-extras="true" style="display:none;">
                                <label>
                                    <input class="delivery-extra-input" type="checkbox" name="slot_delivery_pph_<%= Math.floor(slotTime.getTime() / 1000) %>" value="1"
                                           <%= existingPph ? 'checked' : '' %> <%= (isLocked || is_read_only) ? 'disabled' : '' %>>
                                    Postpartum hemorrhage (87.99A)
                                </label>
                                <label>
                                    <input class="delivery-extra-input" type="checkbox" name="slot_delivery_vacuum_<%= Math.floor(slotTime.getTime() / 1000) %>" value="1"
                                           <%= existingVacuum ? 'checked' : '' %> <%= (isLocked || is_read_only) ? 'disabled' : '' %>>
                                    Vacuum delivery (84.21)
                                </label>
                                <label>
                                    <input class="delivery-extra-input" type="checkbox" name="slot_delivery_laceration_<%= Math.floor(slotTime.getTime() / 1000) %>" value="1"
                                           <%= existingLaceration ? 'checked' : '' %> <%= (isLocked || is_read_only) ? 'disabled' : '' %>>
                                    Extensive vaginal laceration (87.89B)
                                </label>
                                <label>
                                    <input class="delivery-extra-input" type="checkbox" name="slot_delivery_dystocia_<%= Math.floor(slotTime.getTime() / 1000) %>" value="1"
                                           <%= existingDystocia ? 'checked' : '' %> <%= (isLocked || is_read_only) ? 'disabled' : '' %>>
                                    Shoulder dystocia (85.69B)
                                </label>
                                <label>
                                    <input class="delivery-extra-input" type="checkbox" name="slot_delivery_placenta_<%= Math.floor(slotTime.getTime() / 1000) %>" value="1"
                                           <%= existingPlacenta ? 'checked' : '' %> <%= (isLocked || is_read_only) ? 'disabled' : '' %>>
                                    Manual removal of placenta (87.6)
                                </label>
                            </div>
                            <div class="triage-extras" data-triage-extras="true" style="display:none;">
                                <label>
                                    <input class="triage-extra-input" type="checkbox" name="slot_extra_nst_<%= Math.floor(slotTime.getTime() / 1000) %>" value="1"
                                           <%= existingNst ? 'checked' : '' %> <%= (isLocked || is_read_only) ? 'disabled' : '' %>>
                                    Non-stress test
                                </label>
                                <label>
                                    <input class="triage-extra-input" type="checkbox" name="slot_extra_speculum_<%= Math.floor(slotTime.getTime() / 1000) %>" value="1"
                                           <%= existingSpeculum ? 'checked' : '' %> <%= (isLocked || is_read_only) ? 'disabled' : '' %>>
                                    Speculum exam
                                </label>
                            </div>
                        </td>
                        <% } else { %>
                        <td></td>
                        <% } %>
                    <% } %>
                </tr>
                <% } %>
            </table>
            <% }) %>
        </form>
    </div>
    <script>
        const ACTIONS_BY_STATUS = {
            Admitted: [
                { value: 'attended', label: 'Attended', needsTime: false, needsDelivery: false },
                { value: 'delivery', label: 'Delivery', needsTime: true, needsDelivery: true }
            ]
        };
        const ACTION_CONFIG = {
            triage_visit: { label: 'Triage Visit', needsTime: false, needsDelivery: false },
            triage_reassessment: { label: 'Triage Re-assessment', needsTime: false, needsDelivery: false },
            attended: { label: 'Attended', needsTime: false, needsDelivery: false },
            delivery: { label: 'Delivery', needsTime: true, needsDelivery: true }
        };

        function getStatusAtTime(option, slotTime) {
            if (!option || !slotTime) return '';
            const triageStart = option.getAttribute('data-triage-start');
            const statusEventsRaw = option.getAttribute('data-status-events') || '[]';
            const admittedAt = option.getAttribute('data-admitted-at');
            const deliveredAt = option.getAttribute('data-delivered-at');
            const dischargedAt = option.getAttribute('data-discharged-at');

            const toDate = (val) => {
                if (!val) return null;
                const parsed = new Date(val);
                return Number.isNaN(parsed.valueOf()) ? null : parsed;
            };

            const triageDt = toDate(triageStart);
            const admittedDt = toDate(admittedAt);
            const deliveredDt = toDate(deliveredAt);
            const dischargedDt = toDate(dischargedAt);

            const baseOrder = { Triage: 1, Admitted: 2, Delivered: 3, Discharged: 4 };
            const events = [];
            if (triageDt) events.push({ time: triageDt, status: 'Triage', order: baseOrder.Triage });
            if (admittedDt) events.push({ time: admittedDt, status: 'Admitted', order: baseOrder.Admitted });
            if (deliveredDt) events.push({ time: deliveredDt, status: 'Delivered', order: baseOrder.Delivered });
            if (dischargedDt) events.push({ time: dischargedDt, status: 'Discharged', order: baseOrder.Discharged });
            let parsedEvents = [];
            try {
                parsedEvents = JSON.parse(statusEventsRaw);
            } catch (err) {
                parsedEvents = [];
            }
            parsedEvents.forEach((event) => {
                const eventTime = toDate(event.occurred_at);
                if (!eventTime) return;
                if (!baseOrder[event.status]) return;
                const afterStatus = (event.after_status || '').trim() || 'Triage';
                const afterOrder = afterStatus.startsWith('event:')
                    ? baseOrder[event.status]
                    : (baseOrder[afterStatus] || baseOrder.Triage);
                events.push({ time: eventTime, status: event.status, order: afterOrder + 0.5 });
            });

            if (!events.length) return '';
            events.sort((a, b) => (a.time - b.time) || (a.order - b.order));
            let status = '';
            events.forEach((event) => {
                if (event.time <= slotTime) {
                    status = event.status;
                }
            });
            return status;
        }

        function applyCellState(cell) {
            if (!cell) return;
            const locked = cell.getAttribute('data-locked') === '1';
            const patientSelect = cell.querySelector('.patient-select');
            const actionSelect = cell.querySelector('.action-select');
            const deliverySel = cell.querySelector('.delivery-select');
            const deliveryTime = cell.querySelector('.delivery-time');
            const timeLabel = cell.querySelector('.slot-time');
            const triageExtras = cell.querySelector('[data-triage-extras]');
            const triageExtraInputs = cell.querySelectorAll('.triage-extra-input');
            const deliveryExtras = cell.querySelector('[data-delivery-extras]');
            const deliveryExtraInputs = cell.querySelectorAll('.delivery-extra-input');

            const selectedOption = patientSelect ? patientSelect.selectedOptions[0] : null;
            const slotTimeRaw = cell.getAttribute('data-slot-time');
            const slotTime = slotTimeRaw ? new Date(slotTimeRaw) : null;
            const status = getStatusAtTime(selectedOption, slotTime);
            let actions = ACTIONS_BY_STATUS[status] ? [...ACTIONS_BY_STATUS[status]] : [];
            const existingAction = actionSelect ? (actionSelect.getAttribute('data-existing-action') || '') : '';
            let currentAction = actionSelect ? (actionSelect.value || existingAction) : '';

            if (!patientSelect || !actionSelect) return;

            if (!patientSelect.value) {
                actionSelect.value = '';
                actionSelect.setAttribute('data-existing-action', '');
                actionSelect.style.display = 'none';
                actionSelect.disabled = true;
                if (deliverySel) {
                    deliverySel.value = '';
                    deliverySel.style.display = 'none';
                    deliverySel.disabled = true;
                }
                if (deliveryTime) {
                    deliveryTime.value = slotTimeRaw || '';
                    deliveryTime.style.display = 'none';
                    deliveryTime.disabled = true;
                }
                if (deliveryExtras) {
                    deliveryExtras.style.display = 'none';
                }
                deliveryExtraInputs.forEach((input) => {
                    input.checked = false;
                    input.disabled = true;
                });
                if (triageExtras) {
                    triageExtras.style.display = 'none';
                }
                triageExtraInputs.forEach((input) => {
                    input.checked = false;
                    input.disabled = true;
                });
                if (timeLabel) {
                    timeLabel.style.display = 'none';
                }
                return;
            }

            if (status === 'Triage') {
                const triageAction = selectedOption ? selectedOption.getAttribute('data-triage-action') : '';
                if (triageAction && ACTION_CONFIG[triageAction]) {
                    actions = [{
                        value: triageAction,
                        label: ACTION_CONFIG[triageAction].label,
                        needsTime: ACTION_CONFIG[triageAction].needsTime,
                        needsDelivery: ACTION_CONFIG[triageAction].needsDelivery
                    }];
                    if (!currentAction) {
                        actionSelect.setAttribute('data-existing-action', triageAction);
                        currentAction = triageAction;
                    }
                } else {
                    actions = [];
                }
            }

            actionSelect.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = '--';
            actionSelect.appendChild(placeholder);
            actions.forEach((action) => {
                const opt = document.createElement('option');
                opt.value = action.value;
                opt.textContent = action.label;
                actionSelect.appendChild(opt);
            });
            const hasActions = actions.length > 0;
            if (!hasActions) {
                const emptyOpt = document.createElement('option');
                emptyOpt.value = '';
                emptyOpt.textContent = 'No actions';
                actionSelect.appendChild(emptyOpt);
            }
            actionSelect.style.display = 'block';
            actionSelect.disabled = locked || !hasActions;
            if (currentAction) {
                actionSelect.value = currentAction;
            }

            const selectedAction = actions.find((a) => a.value === actionSelect.value) || null;
            const actionMeta = selectedAction || ACTION_CONFIG[actionSelect.value] || null;
            const showDelivery = actionMeta && actionMeta.needsDelivery;
            const showTime = actionMeta && actionMeta.needsTime;

            if (deliverySel) {
                deliverySel.style.display = showDelivery ? 'block' : 'none';
                if (!showDelivery) deliverySel.value = '';
                deliverySel.disabled = !showDelivery || locked;
            }
            if (deliveryTime) {
                deliveryTime.style.display = showTime ? 'block' : 'none';
                deliveryTime.disabled = !showTime || locked;
            }
            if (timeLabel) {
                timeLabel.style.display = showTime ? 'block' : 'none';
            }
            if (deliveryExtras) {
                const showDeliveryExtras = actionSelect.value === 'delivery';
                deliveryExtras.style.display = showDeliveryExtras ? 'block' : 'none';
                deliveryExtraInputs.forEach((input) => {
                    if (!showDeliveryExtras) {
                        input.checked = false;
                    }
                    input.disabled = !showDeliveryExtras || locked;
                    if (showDeliveryExtras) {
                        input.onchange = () => saveGrid();
                    }
                });
            }
            if (triageExtras) {
                const showExtras = actionSelect.value === 'triage_visit' || actionSelect.value === 'triage_reassessment';
                triageExtras.style.display = showExtras ? 'block' : 'none';
                triageExtraInputs.forEach((input) => {
                    if (!showExtras) {
                        input.checked = false;
                    }
                    input.disabled = !showExtras || locked;
                    if (showExtras) {
                        input.onchange = () => saveGrid();
                    }
                });
            }
        }
        function setSavingIndicator() {
            const indicator = document.getElementById('save-indicator');
            if (!indicator) return;
            indicator.textContent = 'Saving...';
        }
        function setExitDisabled(disabled) {
            document.querySelectorAll('a[data-save-grid]').forEach((link) => {
                if (disabled) {
                    link.classList.add('disabled-link');
                    link.setAttribute('aria-disabled', 'true');
                } else {
                    link.classList.remove('disabled-link');
                    link.removeAttribute('aria-disabled');
                }
            });
        }

        function validateGrid() {
            const warningBanner = document.getElementById('grid-warning');
            const warnings = [];
            document.querySelectorAll('td.cell-warning').forEach((cell) => {
                cell.classList.remove('cell-warning');
            });

            document.querySelectorAll('td').forEach((cell) => {
                const patientSelect = cell.querySelector('.patient-select');
                const actionSelect = cell.querySelector('.action-select');
                if (!patientSelect || !actionSelect) return;
                if (!patientSelect.value) return;
                const action = actionSelect.value || '';
                if (!action) {
                    warnings.push('Select an action for each patient slot.');
                    cell.classList.add('cell-warning');
                    return;
                }
                if (action === 'delivery') {
                    const deliveryTimeInput = cell.querySelector('.delivery-time');
                    const slotTimeRaw = cell.getAttribute('data-slot-time');
                    if (deliveryTimeInput && deliveryTimeInput.value && slotTimeRaw) {
                        const slotStart = new Date(slotTimeRaw);
                        const slotEnd = new Date(slotStart.getTime() + 15 * 60 * 1000);
                        const deliveryTime = new Date(deliveryTimeInput.value);
                        if (deliveryTime < slotStart || deliveryTime >= slotEnd) {
                            warnings.push('Delivery time must fall within the selected 15-minute slot.');
                            cell.classList.add('cell-warning');
                        }
                    }
                }
            });

            if (warningBanner) {
                if (warnings.length) {
                    warningBanner.textContent = warnings[0];
                    warningBanner.style.display = 'block';
                } else {
                    warningBanner.textContent = '';
                    warningBanner.style.display = 'none';
                }
            }
            const isValid = warnings.length === 0;
            setExitDisabled(!isValid);
            return isValid;
        }

        function saveGrid(callback) {
            const form = document.getElementById('grid-form');
            if (!form) { if (callback) callback(); return false; }
            if (!validateGrid()) { return false; }
            const data = new FormData(form);
            setSavingIndicator();
            fetch(form.action, { method: 'POST', body: data, headers: {'X-Requested-With': 'fetch'}, keepalive: true })
                .finally(() => { updateSaveIndicator(); if (callback) callback(); });
            return false;
        }
        function updateSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            if (!indicator) return;
            const now = new Date();
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            const ss = String(now.getSeconds()).padStart(2, '0');
            indicator.textContent = `Saved: ${hh}:${mm}:${ss}`;
        }
        function beaconSave() {
            const form = document.getElementById('grid-form');
            if (!form || !navigator.sendBeacon) { return false; }
            const payload = new URLSearchParams(new FormData(form));
            setSavingIndicator();
            const sent = navigator.sendBeacon(form.action, payload);
            if (sent) updateSaveIndicator();
            return sent;
        }
        document.querySelectorAll('a[data-save-grid]').forEach((link) => {
            link.addEventListener('click', (event) => {
                if (event.defaultPrevented || event.button !== 0 || event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) {
                    return;
                }
                event.preventDefault();
                saveGrid(() => { window.location = link.href; });
            });
        });
        document.querySelectorAll('td').forEach((cell) => {
            if (cell.querySelector('.patient-select')) {
                applyCellState(cell);
            }
        });
        validateGrid();
        updateSaveIndicator();
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                beaconSave();
            }
        });
        window.addEventListener('beforeunload', () => {
            beaconSave();
        });
    </script>
</body>
</html>
